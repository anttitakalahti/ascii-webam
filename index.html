<!DOCTYPE HTML>
<html>
    <head>
        <title>ASCII webcam - because I can</title>
        <style>
            canvas, video {
                display: none;
            }
            pre {
                font-family:"Courier New", Monospace;
                font-size: 6px;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <video autoplay></video>
        <canvas></canvas>
        <pre id="output">
        </pre>
        <script src="stringUtils.js"></script>
        <script>

            var gotFirstImage = false
            var prevImage = ''

            navigator.getMedia = ( navigator.getUserMedia ||
                                   navigator.webkitGetUserMedia ||
                                   navigator.mozGetUserMedia ||
                                   navigator.msGetUserMedia)
            navigator.getMedia (
                {
                    video: true,
                    audio: false
                },
                function(localMediaStream) {
                    var video = document.querySelector('video')
                    video.src = window.URL.createObjectURL(localMediaStream)
                    video.onloadedmetadata = function(e) {
                        gotFirstImage = true
                        captureImage()
                    }
                },
                function(err) { console.log("The following error occured: " + err) }
            )

            function captureImage() {
                if (!gotFirstImage) { return }
                    
                var video = document.querySelector('video')
                if (!video) { return }
        
                var canvas = document.querySelector('canvas')
        
                canvas.width = video.videoWidth
                canvas.height = video.videoHeight

                var context = canvas.getContext('2d')
                context.drawImage(video, 0, 0, canvas.width, canvas.height)

                var idata = context.getImageData(0,0,640,480)
                var data = idata.data
        
                var nextImage = stringUtils.getString(data, 640, 480)

                var changePercentageInUpperRightCorner =
                    stringUtils
                        .calculateChangePercentageInUpperRightCorner(prevImage, nextImage)
                
                if (changePercentageInUpperRightCorner > 0.1) {
                    console.log('I am change!')
                }

                document.getElementById('output').innerHTML = nextImage

                prevImage = nextImage
            }

            var t=setInterval(captureImage, 100)
        </script>
    </body>
</html>
